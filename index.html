<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WaniKani Level 60 Predictor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;600;800&family=DM+Mono:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --ink: #1a1410;
      --paper: #f5f0e8;
      --red: #c0392b;
      --red-dark: #a93226;
      --gold: #c9943a;
      --muted: #8a7f72;
      --border: #d4c9b8;
      --card: #fffdf8;
    }

    html { font-size: 16px; }

    body {
      background: var(--paper);
      color: var(--ink);
      font-family: 'DM Mono', monospace;
      min-height: 100vh;
      padding: 48px 20px 80px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: 'æ¼¢å­—';
      position: fixed;
      top: -80px; right: -60px;
      font-family: 'Shippori Mincho', serif;
      font-size: 420px;
      color: rgba(192,57,43,0.035);
      pointer-events: none;
      line-height: 1;
      font-weight: 800;
      user-select: none;
    }

    /* â”€â”€ layout â”€â”€ */
    .wrap { max-width: 740px; margin: 0 auto; }

    /* â”€â”€ header â”€â”€ */
    header {
      text-align: center;
      margin-bottom: 52px;
      animation: fadeUp 0.6s ease both;
    }
    header h1 {
      font-family: 'Shippori Mincho', serif;
      font-size: clamp(32px, 6vw, 56px);
      font-weight: 800;
      letter-spacing: -1.5px;
      line-height: 1.1;
    }
    header h1 em { color: var(--red); font-style: normal; }
    header p {
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin-top: 12px;
    }

    /* â”€â”€ card â”€â”€ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 28px 28px 28px 34px;
      position: relative;
      margin-bottom: 20px;
      animation: fadeUp 0.6s ease both;
    }
    .card::before {
      content: '';
      position: absolute;
      left: 0; top: 0;
      width: 4px; height: 100%;
      background: var(--red);
      border-radius: 2px 0 0 2px;
    }
    .card.gold::before { background: var(--gold); }

    /* â”€â”€ typography utilities â”€â”€ */
    .eyebrow {
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }

    /* â”€â”€ input row â”€â”€ */
    .input-row { display: flex; gap: 10px; }
    .input-row input {
      flex: 1;
      background: var(--paper);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 12px 16px;
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      color: var(--ink);
      outline: none;
      transition: border-color 0.2s;
      min-width: 0;
    }
    .input-row input:focus { border-color: var(--red); }
    .input-row input::placeholder { color: var(--muted); }

    .btn {
      background: var(--red);
      color: #fff;
      border: none;
      border-radius: 2px;
      padding: 12px 26px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .btn:hover { background: var(--red-dark); }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { background: var(--muted); cursor: not-allowed; transform: none; }
    .btn.ghost {
      background: transparent;
      color: var(--red);
      border: 1px solid var(--red);
    }
    .btn.ghost:hover { background: var(--red); color: #fff; }

    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.6;
    }
    .hint a { color: var(--red); text-decoration: none; }
    .hint a:hover { text-decoration: underline; }

    .error-box {
      margin-top: 12px;
      padding: 10px 14px;
      background: rgba(192,57,43,0.06);
      border-left: 2px solid var(--red);
      font-size: 12px;
      color: var(--red);
      line-height: 1.5;
    }

    /* â”€â”€ loading â”€â”€ */
    #loading {
      text-align: center;
      padding: 64px 20px;
      display: none;
      animation: fadeUp 0.4s ease both;
    }
    .spinner {
      width: 32px; height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ results â”€â”€ */
    #results { display: none; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      margin-bottom: 20px;
    }
    @media (max-width: 560px) { .stats-grid { grid-template-columns: repeat(2,1fr); } }

    .stat {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 18px 14px;
      text-align: center;
      animation: fadeUp 0.5s ease both;
    }
    .stat-val {
      font-family: 'Shippori Mincho', serif;
      font-size: 30px;
      font-weight: 800;
      color: var(--red);
      line-height: 1;
    }
    .stat-lbl {
      font-size: 9px;
      letter-spacing: 0.13em;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 6px;
    }

    /* â”€â”€ big prediction â”€â”€ */
    .big-pred {
      background: var(--ink);
      color: var(--paper);
      border-radius: 2px;
      padding: 40px 36px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
      animation: fadeUp 0.55s ease both;
    }
    .big-pred::after {
      content: '60';
      position: absolute;
      right: -14px; bottom: -36px;
      font-family: 'Shippori Mincho', serif;
      font-size: 180px; font-weight: 800;
      color: rgba(255,255,255,0.04);
      pointer-events: none; line-height: 1;
      user-select: none;
    }
    .big-pred .eyebrow { color: rgba(245,240,232,0.4); }
    .pred-date {
      font-family: 'Shippori Mincho', serif;
      font-size: clamp(30px, 6vw, 54px);
      font-weight: 800;
      letter-spacing: -1px;
      line-height: 1.1;
      margin: 10px 0 6px;
    }
    .pred-sub {
      font-size: 12px;
      color: rgba(245,240,232,0.45);
      font-style: italic;
    }

    /* pace pills */
    .pace-row {
      display: flex; gap: 8px; flex-wrap: wrap;
      margin-top: 22px;
    }
    .pace-pill {
      flex: 1; min-width: 80px;
      padding: 8px 10px;
      border: 1px solid rgba(245,240,232,0.18);
      background: transparent;
      border-radius: 2px;
      font-family: 'DM Mono', monospace;
      font-size: 9px; letter-spacing: 0.12em; text-transform: uppercase;
      cursor: pointer; color: rgba(245,240,232,0.35);
      transition: all 0.2s;
      text-align: center;
    }
    .pace-pill:hover { border-color: rgba(245,240,232,0.4); color: rgba(245,240,232,0.7); }
    .pace-pill.active { background: var(--red); border-color: var(--red); color: #fff; }

    /* scenario row */
    .scenarios {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
      margin-top: 24px; padding-top: 24px;
      border-top: 1px solid rgba(245,240,232,0.1);
    }
    .scenario { text-align: center; }
    .sc-label { font-size: 9px; letter-spacing: 0.13em; text-transform: uppercase; color: rgba(245,240,232,0.35); }
    .sc-year { font-family: 'Shippori Mincho', serif; font-size: 22px; font-weight: 700; margin-top: 5px; }
    .sc-rel { font-size: 10px; color: rgba(245,240,232,0.35); margin-top: 3px; }

    /* â”€â”€ chart â”€â”€ */
    .chart-wrap {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 24px 28px 24px 34px;
      margin-bottom: 20px;
      position: relative;
      animation: fadeUp 0.6s ease both;
    }
    .chart-wrap::before {
      content: '';
      position: absolute; left: 0; top: 0;
      width: 4px; height: 100%;
      background: var(--border);
      border-radius: 2px 0 0 2px;
    }
    .bar-row {
      display: grid;
      grid-template-columns: 28px 1fr 52px;
      gap: 10px; align-items: center;
      margin-bottom: 5px;
    }
    .bar-lv { font-size: 10px; color: var(--muted); text-align: right; }
    .bar-bg { height: 6px; background: var(--border); border-radius: 1px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 1px; transition: width 0.6s cubic-bezier(.4,0,.2,1); }
    .bar-days { font-size: 10px; color: var(--muted); }

    /* â”€â”€ footnote / reset â”€â”€ */
    .footnote { font-size: 10px; color: var(--muted); line-height: 1.8; margin-bottom: 24px; }
    #reset-btn { display: none; width: 100%; margin-bottom: 20px; }

    /* â”€â”€ animations â”€â”€ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .card { animation-delay: 0.05s; }

    /* â”€â”€ demo link â”€â”€ */
    .demo-link { cursor: pointer; color: var(--red); text-decoration: underline; }
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <h1>WaniKani<br /><em>Level 60</em> Predictor</h1>
    <p>Forecast your kanji mastery date</p>
  </header>

  <!-- Input card -->
  <div class="card" id="input-card">
    <div class="eyebrow">WaniKani v2 API Key</div>
    <div class="input-row">
      <input type="password" id="token-input" placeholder="Paste your personal access token..." />
      <button class="btn" id="fetch-btn" onclick="run()">Predict</button>
    </div>
    <div id="error-box" class="error-box" style="display:none"></div>
    <p class="hint">
      Get your key at <a href="https://www.wanikani.com/settings/personal_access_tokens" target="_blank">wanikani.com/settings/personal_access_tokens</a>
      &nbsp;Â·&nbsp; <span class="demo-link" onclick="runDemo()">try demo data</span>
    </p>
  </div>

  <!-- Loading -->
  <div id="loading">
    <div class="spinner"></div>
    <p style="font-size:12px;color:var(--muted);letter-spacing:0.1em">Fetching your journey...</p>
  </div>

  <!-- Results -->
  <div id="results">
    <button class="btn ghost" id="reset-btn" onclick="reset()">â† Start over</button>

    <!-- Stats -->
    <div class="stats-grid" id="stats-grid"></div>

    <!-- Big prediction -->
    <div class="big-pred" id="big-pred">
      <div class="eyebrow">Estimated Level 60 Date</div>
      <div class="pred-date" id="pred-date"></div>
      <div class="pred-sub" id="pred-sub"></div>
      <div style="margin-top:20px">
        <div class="eyebrow" style="margin-bottom:8px">Pace scenario</div>
        <div class="pace-row" id="pace-row"></div>
      </div>
      <div class="scenarios" id="scenarios"></div>
    </div>

    <!-- Level chart -->
    <div class="chart-wrap">
      <div class="eyebrow" id="chart-label"></div>
      <div id="chart"></div>
    </div>

    <p class="footnote">
      ğŸ”´ Significantly above your median pace &nbsp;Â·&nbsp;
      ğŸŸ¡ Faster than usual &nbsp;Â·&nbsp;
      ğŸŸ¢ On track<br />
      Time per level calculated from <em>started_at</em> â†’ <em>passed_at</em>.
      Predictions extrapolate your selected pace across all remaining levels.
    </p>
  </div>

</div>

<script>
// â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _stats = null;
let _currentLevel = 0;
let _activePace = 'median';

// â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const addDays = (d, n) => new Date(d.getTime() + n * 864e5);
const fmtDate = d => d.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
function relDays(d) {
  const diff = Math.round((d - Date.now()) / 864e5);
  if (diff <= 0) return 'in the past';
  if (diff < 30) return `${diff}d from now`;
  if (diff < 365) return `~${Math.round(diff/30)}mo from now`;
  return `~${(diff/365).toFixed(1)}yr from now`;
}

function computeStats(progressions, currentLevel) {
  const done = progressions.filter(p =>
    p.data.passed_at && !p.data.abandoned_at && p.data.level < currentLevel
  );
  if (done.length < 2) return null;
  const durs = done.map(p => (new Date(p.data.passed_at) - new Date(p.data.started_at)) / 864e5);
  const sorted = [...durs].sort((a,b) => a-b);
  const avg = durs.reduce((s,d)=>s+d,0) / durs.length;
  const median = sorted[Math.floor(sorted.length/2)];
  const fast   = sorted[Math.floor(sorted.length*0.25)] || sorted[0];
  const slow   = sorted[Math.floor(sorted.length*0.75)] || sorted[sorted.length-1];
  const rec    = durs.slice(-5);
  const recent = rec.reduce((s,d)=>s+d,0) / rec.length;
  return { avg, median, fast, slow, recent, durs, sorted, done };
}

// â”€â”€ WaniKani fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWK(token) {
  const headers = {
    'Authorization': `Bearer ${token}`,
    'Wanikani-Revision': '20170710'
  };
  const uRes = await fetch('https://api.wanikani.com/v2/user', { headers });
  if (uRes.status === 401) throw new Error('Invalid API key â€” check wanikani.com/settings/personal_access_tokens');
  if (!uRes.ok) throw new Error(`API error ${uRes.status}`);
  const user = await uRes.json();

  let url = 'https://api.wanikani.com/v2/level_progressions';
  let progressions = [];
  while (url) {
    const r = await fetch(url, { headers });
    if (!r.ok) throw new Error(`API error ${r.status}`);
    const j = await r.json();
    progressions = progressions.concat(j.data);
    url = j.pages?.next_url || null;
  }
  return { user, progressions };
}

// â”€â”€ demo data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDemoData() {
  const p = []; let d = new Date('2023-01-15');
  for (let l = 1; l <= 32; l++) {
    const start = new Date(d);
    const days = l<=10 ? 7+Math.random()*4 : l<=20 ? 9+Math.random()*6 : 12+Math.random()*10;
    d = new Date(d.getTime() + days*864e5);
    p.push({ data: { level:l, started_at:start.toISOString(), passed_at: l<32?d.toISOString():null, abandoned_at:null } });
  }
  return { user:{ data:{ current_level:32, username:'demo_user' } }, progressions:p };
}

// â”€â”€ render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(data, isDemo) {
  const lvl = data.user.data.current_level ?? data.user.data.level;
  _currentLevel = lvl;
  const stats = computeStats(data.progressions, lvl);
  _stats = stats;

  if (!stats) {
    showError('Need at least 2 completed level progressions to predict. Keep going! é ‘å¼µã£ã¦ï¼');
    setLoading(false);
    return;
  }

  // stats grid
  const sg = document.getElementById('stats-grid');
  sg.innerHTML = [
    [lvl, 'Current Level'],
    [stats.done.length, 'Levels Passed'],
    [Math.round(stats.median)+'d', 'Median / Level'],
    [Math.round(stats.recent)+'d', 'Recent (5 lvls)'],
  ].map(([v,l],i) => `
    <div class="stat" style="animation-delay:${0.05+i*0.07}s">
      <div class="stat-val">${v}</div>
      <div class="stat-lbl">${l}</div>
    </div>`).join('');

  // pace pills
  const paces = [['fast','Fast 25%'],['median','Median'],['avg','Average'],['recent','Recent 5'],['slow','Slow 75%']];
  document.getElementById('pace-row').innerHTML = paces.map(([k,label]) =>
    `<button class="pace-pill${k===_activePace?' active':''}" onclick="setPace('${k}')">${label}</button>`
  ).join('');

  updatePrediction();

  // chart
  const shown = stats.done.slice(-30);
  const maxD = Math.max(...stats.durs);
  document.getElementById('chart-label').textContent = `Days per level â€” last ${shown.length} levels`;
  document.getElementById('chart').innerHTML = shown.map(p => {
    const days = (new Date(p.data.passed_at) - new Date(p.data.started_at)) / 864e5;
    const pct  = Math.min(100, (days/maxD)*100);
    const col  = days > stats.median*1.5 ? '#c0392b' : days < stats.median*0.7 ? '#c9943a' : '#4a7c59';
    return `<div class="bar-row">
      <div class="bar-lv">${p.data.level}</div>
      <div class="bar-bg"><div class="bar-fill" style="width:${pct}%;background:${col}"></div></div>
      <div class="bar-days">${Math.round(days)}d</div>
    </div>`;
  }).join('') + `<div class="bar-row" style="margin-top:6px">
    <div class="bar-lv" style="color:var(--red)">${lvl}</div>
    <div class="bar-bg"><div class="bar-fill" style="width:35%;background:repeating-linear-gradient(45deg,var(--border),var(--border) 2px,transparent 2px,transparent 6px)"></div></div>
    <div class="bar-days" style="font-style:italic">now</div>
  </div>`;

  // show/hide sections
  document.getElementById('input-card').style.display = 'none';
  document.getElementById('loading').style.display = 'none';
  document.getElementById('results').style.display = 'block';
  document.getElementById('reset-btn').style.display = 'block';

  if (isDemo) {
    const note = document.createElement('p');
    note.style.cssText = 'text-align:center;font-size:11px;color:var(--muted);margin-bottom:16px';
    note.textContent = 'Showing demo data â€” enter your real API key for actual predictions';
    document.getElementById('results').prepend(note);
  }
}

function updatePrediction() {
  if (!_stats) return;
  const stats = _stats;
  const lvl   = _currentLevel;
  const left  = 60 - lvl;
  const paceMap = { fast:stats.fast, median:stats.median, avg:stats.avg, slow:stats.slow, recent:stats.recent };
  const dpL   = paceMap[_activePace] || stats.median;
  const pred  = addDays(new Date(), left * dpL);
  const fast  = addDays(new Date(), left * stats.fast);
  const mid   = addDays(new Date(), left * stats.median);
  const slow  = addDays(new Date(), left * stats.slow);

  document.getElementById('pred-date').textContent = fmtDate(pred);
  document.getElementById('pred-sub').textContent =
    `${relDays(pred)} Â· ${Math.round(dpL)}d/level Â· ${left} levels remaining`;

  document.getElementById('scenarios').innerHTML = [
    ['Optimistic', fast],
    ['Median', mid],
    ['Conservative', slow],
  ].map(([label,d]) => `<div class="scenario">
    <div class="sc-label">${label}</div>
    <div class="sc-year">${d.getFullYear()}</div>
    <div class="sc-rel">${relDays(d)}</div>
  </div>`).join('');

  // update pills
  document.querySelectorAll('.pace-pill').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.toLowerCase().startsWith(_activePace.slice(0,4).toLowerCase()) || btn.onclick?.toString().includes(`'${_activePace}'`));
  });
  // re-render pills cleanly
  const paces = [['fast','Fast 25%'],['median','Median'],['avg','Average'],['recent','Recent 5'],['slow','Slow 75%']];
  document.getElementById('pace-row').innerHTML = paces.map(([k,label]) =>
    `<button class="pace-pill${k===_activePace?' active':''}" onclick="setPace('${k}')">${label}</button>`
  ).join('');
}

function setPace(p) { _activePace = p; updatePrediction(); }

// â”€â”€ main actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function run() {
  const token = document.getElementById('token-input').value.trim();
  if (!token) { showError('Please enter your API key.'); return; }
  clearError();
  setLoading(true);
  try {
    const data = await fetchWK(token);
    render(data, false);
  } catch(e) {
    setLoading(false);
    showError(e.message);
  }
}

function runDemo() {
  clearError();
  setLoading(true);
  setTimeout(() => render(getDemoData(), true), 300);
}

function reset() {
  document.getElementById('input-card').style.display = 'block';
  document.getElementById('results').style.display = 'none';
  document.getElementById('reset-btn').style.display = 'none';
  // remove demo note if present
  const note = document.querySelector('#results > p');
  if (note) note.remove();
  _stats = null;
  _activePace = 'median';
}

// â”€â”€ ui helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(on) {
  document.getElementById('loading').style.display = on ? 'block' : 'none';
  document.getElementById('input-card').style.display = on ? 'none' : 'block';
  document.getElementById('fetch-btn').disabled = on;
}
function showError(msg) {
  const el = document.getElementById('error-box');
  el.textContent = msg;
  el.style.display = 'block';
}
function clearError() {
  document.getElementById('error-box').style.display = 'none';
}

// enter key
document.getElementById('token-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') run();
});
</script>
</body>
</html>
